name: Update Metrics
on:
  push:
  workflow_dispatch: {}
  #schedule:
  #  - cron:  '0 5 * 1-2,11-12 *' # 12:00 AM EST
  #  - cron:  '0 4 * 3-10 *' # 12:00 AM EST during DST

concurrency:
  group: metrics
  cancel-in-progress: true

jobs:
  metrics:
    name: Generate Metrics
    runs-on: ubuntu-latest
    steps:
      - name: üì§ Checkout Repository
        uses: actions/checkout@v2.4.0

      - name: Code
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.16
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: code16.svg
          plugin_code: yes
          plugin_code_load: 300
          plugin_code_lines: 20
          plugin_code_visibility: public
          plugin_code_skipped: ${{ secrets.SKIPPED }}

      - name: Code
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: code17.svg
          plugin_code: yes
          plugin_code_load: 300
          plugin_code_lines: 20
          plugin_code_visibility: public
          plugin_code_skipped: ${{ secrets.SKIPPED }}

      - name: üìÅ Move output
        if: ${{ success() || failure() }}
        run: |
          sudo mv /metrics_renders/* ./metrics

      - name: üì• Commit Changes
        if: ${{ success() || failure() }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -f metrics
          git diff-index --quiet HEAD || git commit -m 'Update Metrics'
          git push