name: Update Metrics
on:
  push:
  workflow_dispatch: {}
  #schedule:
  #  - cron:  '0 5 * 1-2,11-12 *' # 12:00 AM EST
  #  - cron:  '0 4 * 3-10 *' # 12:00 AM EST during DST

jobs:
  metrics:
    name: Generate Metrics
    runs-on: ubuntu-latest
    steps:
      - name: üì§ Checkout Repository
        uses: actions/checkout@v2.4.0

      - name: User
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: header, activity, community, repositories
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: user.svg
          repositories_affiliations: owner, collaborator, organization_member
          repositories_skipped: ${{ secrets.SKIPPED }}

      - name: Organization
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: header, activity, community, repositories
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: organization.svg
          user: KatsuteDev
          repositories_affiliations: owner, collaborator, organization_member
          repositories_skipped: ${{ secrets.SKIPPED }}

      - name: Calendar
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: calendar.svg
          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year

      - name: Languages
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: languages.svg
          plugin_languages: yes
          plugin_languages_skipped: ${{ secrets.SKIPPED }}
          plugin_languages_limit: 8
          plugin_languages_sections: most-used
          plugin_languages_details: bytes-size, percentage
          plugin_languages_threshold: 2%

      - name: Habits
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: habits.svg
          plugin_habits: yes
          plugin_habits_days: 30
          plugin_habits_facts: no
          plugin_habits_charts: yes
          plugin_habits_trim: no
          config_timezone: America/New_York

      - name: Issues
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: issues.svg
          plugin_followup: yes
          plugin_followup_sections: repositories, user
          extras_css: |
            div.row.fill-width > section:first-of-type path[fill="#8957e5"],
            div.row.fill-width > section:first-of-type rect[fill="#8957e5"] {
                fill: #da3633;
            }

      - name: Issues (organization)
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: issues-organization.svg
          user: KatsuteDev
          plugin_followup: yes
          plugin_followup_sections: repositories
          extras_css: |
            div.row.fill-width > section:first-of-type path[fill="#8957e5"],
            div.row.fill-width > section:first-of-type rect[fill="#8957e5"] {
                fill: #da3633;
            }

      - name: Code
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: code.svg
          plugin_code: yes
          plugin_code_lines: 20
          plugin_code_visibility: public
          plugin_code_skipped: ${{ secrets.SKIPPED }}

      - name: Discussions
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: discussions.svg
          plugin_discussions: yes

      - name: Support
        if: ${{ success() || failure() }}
        uses: lowlighter/metrics@v3.17
        with:
          token: ${{ secrets.METRICS }}
          # core
          base: ""
          delay: 60
          verify: yes
          retries: 3
          retries_delay: 120
          output_action: none
          use_prebuilt_image: yes
          # plugin
          filename: support.svg
          plugin_support: yes

      - name: üìÅ Move output
        run: mv /metrics_renders/* /metrics

      - name: üì• Commit Changes
        if: ${{ success() || failure() }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -f metrics
          git diff-index --quiet HEAD || git commit -m 'Update Metrics'
          git push
